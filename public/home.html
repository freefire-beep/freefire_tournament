<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Nexus - Home</title>
    <style>
        body { background-color: #0d1117; color: white; margin: 0; padding-bottom: 80px; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* üî• ‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶è‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        .fire-wrapper { position: relative; width: 60px; height: 60px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .flame {
            position: absolute; bottom: 15px; width: 35px; height: 35px;
            background: radial-gradient(circle, #ffcc00 20%, #ff4500 60%, rgba(255, 69, 0, 0) 80%);
            border-radius: 50% 50% 20% 50%; transform: rotate(-45deg);
            filter: blur(2px); animation: burn 0.4s infinite alternate;
            box-shadow: 0 0 15px #ff4500; z-index: 1;
        }
        @keyframes burn { 0% { transform: rotate(-45deg) scale(1); opacity: 0.8; } 100% { transform: rotate(-45deg) scale(1.2); opacity: 1; } }
        .store-btn-box { position: relative; z-index: 5; background: rgba(22, 27, 34, 0.9); border: 1px solid #ff4500; border-radius: 10px; padding: 4px 8px; text-align: center; }

        /* üìã ‡¶ü‡ßÅ‡¶∞‡ßç‡¶®‡¶æ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ì ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .match-card { background: #161b22; padding: 18px; border-radius: 15px; border: 1px solid #30363d; margin-bottom: 15px; position: relative; }
        .timer-badge { position: absolute; top: 10px; right: 10px; font-size: 11px; background: rgba(255, 204, 0, 0.1); color: #ffcc00; padding: 4px 8px; border-radius: 5px; border: 1px solid #ffcc00; font-weight: bold; }
        
        /* üìã ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        #detailsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-card { background: #161b22; width: 85%; max-width: 400px; border-radius: 20px; border: 1px solid #58a6ff; padding: 20px; animation: pop 0.3s ease; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .detail-item { background: #0d1117; padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid #ff4500; font-size: 14px; }
        .applied-tag { color: #238636; font-weight: bold; font-size: 13px; border: 1px solid #238636; padding: 8px 15px; border-radius: 8px; background: rgba(35, 134, 54, 0.1); }
        .full-tag { color: #f85149; font-weight: bold; font-size: 14px; border: 1px solid #f85149; padding: 8px 15px; border-radius: 8px; }
        
        /* üîò ‡¶®‡ßç‡¶Ø‡¶æ‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #161b22; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #30363d; z-index: 100; }
        .nav-btn { background:none; border:none; color:gray; cursor:pointer; font-size: 14px; text-decoration: none; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn.active { color:#58a6ff; font-weight:bold; }
    </style>
</head>
<body>

    <script>
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user || !user.gameId) {
            window.location.href = 'index.html';
        }
    </script>

    <div style="padding: 10px 15px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; border-bottom: 1px solid #30363d; position: sticky; top:0; background:#0d1117; z-index:90;">
        <div class="fire-wrapper" onclick="location.href='store.html'">
            <div class="flame"></div>
            <div class="store-btn-box">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="2.5"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                <div style="font-size: 8px; color: #ffcc00; font-weight: bold;">STORE</div>
            </div>
        </div>
        <h3 style="color: #58a6ff; letter-spacing: 1px; margin: 0; font-weight: 800;">ELITE NEXUS</h3>
        <div style="text-align: right;">
            <div style="background: #161b22; padding: 5px 12px; border-radius: 20px; border: 1px solid #58a6ff; display: inline-flex; align-items: center; gap: 6px;">
                <span id="userCoins" style="font-weight: bold; color: #f0e68c; font-size: 14px;">...</span> ü™ô
            </div>
        </div>
    </div>

    <div style="padding: 20px;">
        <h2 style="font-size: 18px; border-left: 4px solid #58a6ff; padding-left: 10px; margin-bottom: 20px;">Live Tournaments</h2>
        <div id="tournamentList">
            <p style="text-align: center; color: gray;">Loading Matches...</p>
        </div>
    </div>

    <div id="detailsModal">
        <div class="modal-card">
            <h2 id="mTitle" style="color: #58a6ff; margin-top: 0; font-size: 20px;"></h2>
            <div class="detail-item">üó∫Ô∏è <b>Map:</b> <span id="mMap"></span></div>
            <div class="detail-item">‚è∞ <b>Time (BD):</b> <span id="mTime"></span></div>
            <div class="detail-item">üèÜ <b>Prize:</b> <span id="mPrize"></span></div>
            <div class="detail-item">üìú <b>Rules:</b> <span id="mRules"></span></div>
            <div style="margin-top: 25px; display: flex; gap: 10px;">
                <button onclick="closeM()" style="flex:1; padding:12px; background:#30363d; color:white; border:none; border-radius:10px; cursor:pointer;">Back</button>
                <button id="joinConfirmBtn" style="flex:2; padding:12px; background:linear-gradient(45deg, #238636, #2ea043); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">Confirm Join</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="inbox.html" class="nav-btn"><span>üìß</span><span>Inbox</span></a>
        <a href="home.html" class="nav-btn active"><span>üè†</span><span>Home</span></a>
        <a href="account.html" class="nav-btn"><span>üë§</span><span>Account</span></a>
    </div>

    <script>
        let allPackages = [];
        let timers = [];

        async function syncData() {
            try {
                // API ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                const res = await fetch(`/api/get-packages?gameId=${user.gameId}`);
                if (!res.ok) throw new Error("Fetch failed");
                const data = await res.json();
                
                allPackages = data.packages;
                document.getElementById('userCoins').innerText = data.coins;
                
                renderMatches(data.joinedPackages || []);
            } catch (err) {
                console.error("Sync Error:", err);
                document.getElementById('tournamentList').innerHTML = "<p style='color:red; text-align:center;'>Error loading matches!</p>";
            }
        }

        // ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡ßü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ (GMT+6)
        function startTimer(targetTime, elementId) {
            function update() {
                const now = new Date();
                // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡¶Æ‡ßü‡¶ï‡ßá UTC ‡¶§‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ (GMT+6) ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                const bdNow = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 6));
                
                const diff = new Date(targetTime).getTime() - bdNow.getTime();
                const el = document.getElementById(elementId);
                if (!el) return;

                if (diff <= 0) {
                    el.innerText = "Ongoing / Closed";
                    el.style.color = "#ff7b72";
                    return;
                }

                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                el.innerText = `${h}h ${m}m ${s}s left`;
            }
            update();
            const interval = setInterval(update, 1000);
            timers.push(interval);
        }

        function renderMatches(joinedIds) {
            const list = document.getElementById('tournamentList');
            list.innerHTML = "";
            timers.forEach(t => clearInterval(t)); // ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ

            allPackages.forEach((pkg, index) => {
                // ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ: Match_ID ‡¶¨‡¶æ Title ‡¶¶‡¶ø‡ßü‡ßá ‡¶ö‡ßá‡¶ï
                const isJoined = joinedIds.includes(pkg.Match_ID) || joinedIds.includes(pkg.Title); 
                const total = parseInt(pkg.Total_Slots) || 48;
                const joined = parseInt(pkg.Joined_Players) || 0;
                const isFull = joined >= total;
                const timerId = `timer-${index}`;

                list.innerHTML += `
                    <div class="match-card">
                        <div id="${timerId}" class="timer-badge">Loading...</div>
                        <h3 style="margin: 0; color: #58a6ff;">${pkg.Title}</h3>
                        <p style="font-size: 12px; color: gray; margin: 8px 0;">
                            üë• Players: <span style="color:white; font-weight:bold;">${joined}/${total}</span>
                        </p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <div style="font-weight:bold; color:#f0e68c; font-size: 15px;">Fee: ${pkg.Fee} ü™ô</div>
                            
                            ${isJoined ? 
                                `<span class="applied-tag">Applied ‚úÖ</span>` : 
                                (isFull ? 
                                    `<span class="full-tag">FULL üö´</span>` : 
                                    `<button onclick="openM('${pkg.Match_ID || pkg.Title}')" style="background:linear-gradient(45deg, #238636, #2ea043); color:white; border:none; padding:10px 25px; border-radius:8px; font-weight:bold; cursor:pointer; box-shadow: 0 4px 10px rgba(35,134,54,0.3);">JOIN NOW</button>`
                                )
                            }
                        </div>
                    </div>
                `;

                if (pkg.Time) startTimer(pkg.Time, timerId);
            });
        }

        function openM(id) {
            const pkg = allPackages.find(p => (p.Match_ID === id || p.Title === id));
            if(!pkg) return;

            document.getElementById('mTitle').innerText = pkg.Title;
            document.getElementById('mMap').innerText = pkg.Map || "Bermuda";
            document.getElementById('mTime').innerText = pkg.Time || "TBA";
            document.getElementById('mPrize').innerText = pkg.Prize_Pool || "Check Rules";
            document.getElementById('mRules').innerText = pkg.Rules || "No Cheating!";
            
            const joinBtn = document.getElementById('joinConfirmBtn');
            joinBtn.disabled = false;
            joinBtn.innerText = "Confirm Join";
            joinBtn.onclick = () => processJoin(pkg);
            
            document.getElementById('detailsModal').style.display = 'flex';
        }

        async function processJoin(pkg) {
            const btn = document.getElementById('joinConfirmBtn');
            btn.disabled = true;
            btn.innerText = "Joining...";

            try {
                const res = await fetch('/api/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        gameId: user.gameId, 
                        fee: pkg.Fee, 
                        packageName: pkg.Title,
                        matchId: pkg.Match_ID || "",
                        userName: user.name 
                    })
                });
                
                const result = await res.json();

                if (res.ok) {
                    alert("Tournament Joined Successfully! ‚úÖ");
                    window.location.reload(); // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
                } else {
                    alert(result.message || "Join failed!");
                    btn.disabled = false;
                    btn.innerText = "Confirm Join";
                }
            } catch (e) {
                alert("Network Error! Try again.");
                btn.disabled = false;
                btn.innerText = "Confirm Join";
            }
        }

        function closeM() { document.getElementById('detailsModal').style.display = 'none'; }

        // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨‡ßá
        syncData();
    </script>
</body>
                                                                              </html>
    
