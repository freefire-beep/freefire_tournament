<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Nexus - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="background-color: #0d1117; color: white; margin: 0; padding-bottom: 70px;">

    <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #30363d;">
        <h3 style="color: #58a6ff; margin: 0;">ELITE NEXUS</h3>
        <div style="background: #161b22; padding: 5px 12px; border-radius: 20px; border: 1px solid #58a6ff;">
            <span id="userCoins">Loading...</span> ü™ô
        </div>
    </div>

    <div id="packageContainer" style="padding: 15px;">
        <p id="loadingText" style="text-align: center; color: gray;">Loading Matches...</p>
    </div>

    <div style="position: fixed; bottom: 0; width: 100%; background: #161b22; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #30363d;">
        <button onclick="location.href='inbox.html'" style="background:none; border:none; color:gray; cursor:pointer;">üìß Inbox</button>
        <button onclick="location.href='home.html'" style="background:none; border:none; color:#58a6ff; cursor:pointer;">üè† Home</button>
        <button onclick="location.href='account.html'" style="background:none; border:none; color:gray; cursor:pointer;">üë§ Account</button>
    </div>

    <script>
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï
        const user = JSON.parse(sessionStorage.getItem('user'));
        if(!user) location.href = 'index.html';

        // ‡ßß. ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú, ‡¶ï‡ßü‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ú‡ßü‡ßá‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡¶æ
        async function syncHomeData() {
            try {
                // ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã API ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶®‡ßá‡¶á, ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶è‡¶®‡ßç‡¶°‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶≤
                const response = await fetch(`/api/get-packages?gameId=${user.gameId}`);
                if (!response.ok) throw new Error();
                
                const data = await response.json();
                
                // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶ï‡ßü‡ßá‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                document.getElementById('userCoins').innerText = data.coins;
                user.coins = data.coins;
                sessionStorage.setItem('user', JSON.stringify(user));

                renderPackages(data.packages, data.joinedPackages);
            } catch (err) {
                document.getElementById('loadingText').innerText = "Network Error! Please Refresh.";
            }
        }

        // ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú‡¶ó‡ßÅ‡¶≤‡ßã ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
        function renderPackages(packages, joinedList) {
            const container = document.getElementById('packageContainer');
            container.innerHTML = "";
            
            if(packages.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:gray;'>No matches available.</p>";
                return;
            }

            packages.forEach(pkg => {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá?
                const isJoined = joinedList.includes(pkg.Name);

                container.innerHTML += `
                    <div style="background:#161b22; padding:20px; border-radius:15px; margin-bottom:15px; border:1px solid #30363d; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h4 style="margin:0;">${pkg.Name}</h4>
                            <small style="color:#58a6ff; font-weight:bold;">Entry: ‡ß≥ ${pkg.Price}</small>
                        </div>
                        <button class="join-btn" 
                            id="btn-${pkg.Name.replace(/\s+/g, '')}"
                            ${isJoined ? 'disabled' : ''} 
                            onclick="buyPackage(this, '${pkg.Name}', ${pkg.Price})" 
                            style="background:${isJoined ? '#30363d' : 'linear-gradient(to right, #00d2ff, #3a7bd5)'}; color:white; border:none; padding:8px 20px; border-radius:5px; cursor:${isJoined ? 'not-allowed' : 'pointer'}; font-weight:bold;">
                            ${isJoined ? 'Joined' : 'Join'}
                        </button>
                    </div>
                `;
            });
        }

        async function buyPackage(btn, title, fee) {
            if(!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡ß≥ ${fee} ‡¶¶‡¶ø‡ßü‡ßá ${title} ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) return;

            // ‡ß®. ‡¶≤‡¶ï ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ: ‡¶∏‡¶¨ ‡¶ú‡ßü‡ßá‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡ßç‡¶∞‡¶ø‡¶ú ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
            const allBtns = document.querySelectorAll('.join-btn');
            allBtns.forEach(b => { 
                b.disabled = true; 
                b.style.opacity = "0.5"; 
            });

            btn.innerText = "Processing...";

            try {
                const response = await fetch('/api/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        gameId: user.gameId, 
                        fee: fee, 
                        packageName: title, 
                        userName: user.name 
                    })
                });

                const data = await response.json();

                if(response.ok) {
                    // ‡ß©. ‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶ï‡ßü‡ßá‡¶® ‡¶∂‡ßã ‡¶ï‡¶∞‡¶æ
                    document.getElementById('userCoins').innerText = data.newBalance;
                    alert("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡¶®!");
                    btn.innerText = "Joined";
                    btn.style.background = "#30363d";
                } else {
                    // ‡ß™. ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶´‡ßá‡¶á‡¶≤ ‡¶π‡¶≤‡ßá ‡¶è‡¶∞‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                    alert(data.message);
                    syncHomeData(); // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ
                }
            } catch (err) {
                // ‡ß´. ‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶≤‡ßá ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶æ
                alert("‡¶®‡ßá‡¶ü‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            } finally {
                // ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶ú‡ßü‡ßá‡¶® ‡¶®‡¶æ ‡¶π‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá)
                setTimeout(() => {
                    allBtns.forEach(b => {
                        if (b.innerText !== "Joined") {
                            b.disabled = false;
                            b.style.opacity = "1";
                        }
                    });
                }, 3000);
            }
        }

        // ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
        syncHomeData();
    </script>
</body>
    </html>
    
